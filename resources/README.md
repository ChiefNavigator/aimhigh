# Project Design

## 1. 프로젝트 목표
- 타 사업자에게 금액을 입금 받고, 이를 다른 사업자에게 송금하는 기능 구현

## 2. 요구사항 분석
- 기획서 : 뱅킹 서버 프로젝트_ver1.1pdf
- 실패 지점 분석
  - A 사업자로부터 이체 실패하는 경우
  - KCD 계좌에 입금이 실패하는 경우 
  - KCD 계좌에 출금이 실패하는 경우 
  - B 사업자에게 송금 실패하는 경우
- 논리적 트랜잭션 구성
  - 트랜잭션 묶음 기준 : 처리 과정에서 로직이 하나라도 실패했을 때, 비즈니스에 즉각적으로 문제가 발생하는 경우
  - Transaction 1 : 외부로부터 이체받은 내역을 KCD 계좌로 안정적으로 입금하기 위한 트랜잭션 
  - Transcation 2 : KCD 계좌에서 출금하고 이를 타 사업자에게 안정적으로 송금하기 위한 트랜잭션
![image](images/송금API_요구사항분석.png)

- 동시성 제어
    - 계좌 데이터에 동시에 접근할 수 있는 환경
    - 갱실 유실 같은 데이터 정합성 문제를 방지하기 위해 계좌 데이터에 동시성 제어가 필요

## 3. 송금 로직 설계

### 3.1 송금 처리

1. 클라이언트 송금 요청
2. 송금 API 로직 수행 

    2.1 Open API를 통해 사업자 계좌에서 **KCD 계좌** 로 이체 
 
    2.2 **KCD 계좌** 에 입금 금액 업데이트

    2.3 **KCD 계좌 입출금 내역** 에 입금 내역 저장

    2.4 송금 이벤트 발생
3. 송금 이벤트 Kafka

     3.1 발생된 이벤트를 수신하여 출금 API 측에 송금 요청

     3.2 10초 간격으로 3번 송금이 실패하게 될 경우, DeadLetter Queue를 통해 **송금 이벤트 실패 내역** 저장
3. 출금 API 로직 수행

   4.1 **KCD 계좌** 에 출금 금액 업데이트

   4.2 **KCD 계좌 입출금 내역** 에 출금 내역 저장

   4.3 Open API를 통해 **KCD 계좌**에서 사업자 계좌로 송금




### 3.2 송금 실패 처리

- 일정 주기로 송금 이벤트 실패 내역을 조회하여 일괄 출금 처리
- KCD 계좌 출금, KCD 계좌 출금 내역, KCD 계좌에서 사업자 계좌로 송금은 트랜잭션 묶음 처리

![image](images/송금API_서비스로직.png)

## 4. 검증 및 배포 계획

## 5. 일정 계획 (2024-04-03 ~ 2024-04-05)

- [ ] 2024-04-03 ~ 2024-04-03 : 프로젝트 디자인 및 개발 환경 구성 
- [ ] 2024-04-03 ~ 2024-04-04 : 송금 API 개발
- [ ] 2024-04-04 ~ 2024-04-05 : 송금 실패 처리 배치 개발
- [ ] 2024-04-05 ~ 2024-04-05 : 검증 및 버그 수정